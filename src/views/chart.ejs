<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('partials/head'); -%>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
  </head>
  <body>
    <%- include('partials/navigation'); -%> <%- include('partials/header'); -%>
    <center style="height: 800px">
      <h1 id="header" class="waviy">
        <span style="--i: 0">C</span>
        <span style="--i: 1">h</span>
        <span style="--i: 2">a</span>
        <span style="--i: 3">r</span>
        <span style="--i: 4">t</span>
      </h1>
      <hr />

      <div
        style="
          display: flex;
          padding: 10px;
          margin-top: 40px;
          justify-content: center;
        "
      >
        <div
          style="
            height: 80vh;
            min-width: 40%;
            flex: 0;
            border-style: solid;
            padding: 10px;
            margin-right: 30px;
            border-radius: 5px;
          "
        >
          <h1>Most Visited Pages</h1>
          <hr />
          <canvas id="mostViewedPages"></canvas>
        </div>
        <div
          style="
            height: 80vh;
            min-width: 40%;
            flex: 0;
            border-style: solid;
            padding: 10px;
            margin-left: 30px;
            border-radius: 5px;
          "
        >
          <h1>Most Commented Pages</h1>
          <hr />
          <canvas id="mostCommentedPages"></canvas>
        </div>
      </div>
    </center>
    <%- include('partials/footer'); -%>
  </body>
  <%- include('partials/script'); -%>
  <!-- <script src="/js/chart.js"></script> -->
  <script>
    const mostViewedOccuaptionsTable = document.getElementById(
      "mostViewedOccuaptions"
    );
    const mostCommentedOccuaptionsTable = document.getElementById(
      "mostCommentedOccuaptions"
    );

    function getCookie(cname) {
      let id = "";
      let name = cname + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(";");
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == " ") {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          for (var j = 9; j < c.substring(name.length, c.length).length; j++) {
            if (c.substring(name.length, c.length)[j] === '"') {
              break;
            } else {
              id += c.substring(name.length, c.length)[j];
            }
          }
          return id;
        }
      }
      return "";
    }

    const getRandomRgb = function () {
      var num = Math.round(0xffffff * Math.random());
      var r = num >> 16;
      var g = (num >> 8) & 255;
      var b = num & 255;
      return "rgb(" + r + ", " + g + ", " + b + ")";
    };

    try {
      if ($("#signIn").html() === "Sign in") {
      } else {
        socket.emit("addOnlineUser", getCookie("current-user"));
      }
    } catch (error) {
      console.error(error);
    }

    socket.on("getMostViewed", (value) => {
      const data = {
        labels: [],
        datasets: [
          {
            label: "My First Dataset",
            data: [],
            backgroundColor: [],
            hoverOffset: 4,
          },
        ],
      };

      const config = {
        type: "doughnut",
        data: data,
      };

      const keys = Object.keys(value);

      keys.forEach((key, index) => {
        data.labels.push(key);
        data.datasets[0].data.push(value[key]);
        data.datasets[0].backgroundColor.push(getRandomRgb());
      });

      const myChart = new Chart(
        document.getElementById("mostViewedPages"),
        config
      );
    });

    socket.on("getMostCommented", (value) => {
      const data = {
        labels: [],
        datasets: [
          {
            label: "My First Dataset",
            data: [],
            backgroundColor: [],
            hoverOffset: 4,
          },
        ],
      };

      const config = {
        type: "doughnut",
        data: data,
      };

      const keys = Object.keys(value);

      keys.forEach((key, index) => {
        data.labels.push(key);
        data.datasets[0].data.push(value[key]);
        data.datasets[0].backgroundColor.push(getRandomRgb());
      });

      const myChart = new Chart(
        document.getElementById("mostCommentedPages"),
        config
      );
    });
  </script>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('partials/head'); -%>
  </head>
  <body>
    <%- include('partials/navigation'); -%> <%- include('partials/header'); -%>
    <center style="height: 800px">
      <h1 id="header" class="waviy">
        <span style="--i: 0">O</span>
        <span style="--i: 1">n</span>
        <span style="--i: 2">l</span>
        <span style="--i: 3">i</span>
        <span style="--i: 4">n</span>
        <span style="--i: 5">e</span>
      </h1>
      <hr />

      <div
        style="
          display: flex;
          padding: 10px;
          margin-top: 40px;
          justify-content: center;
        "
      >
        <div
          style="
            height: 80vh;
            min-width: 40%;
            flex: 0;
            border-style: solid;
            padding: 10px;
            margin-right: 30px;
            border-radius: 5px;
          "
        >
          <h1>Friends List</h1>
          <hr />
          <table
            id="friendsList"
            class="table table-striped header-fixed"
          ></table>
        </div>
        <div
          style="
            height: 80vh;
            min-width: 40%;
            flex: 0;
            border-style: solid;
            padding: 10px;
            margin-left: 30px;
            border-radius: 5px;
          "
        >
          <h1>Online Users</h1>
          <hr />
          <table
            id="loggedinUser"
            class="table table-striped header-fixed"
          ></table>
        </div>
      </div>
    </center>

    <div class="modal fade" id="showOtherUserProfileModal" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
            <h4 class="modal-title"></h4>
          </div>
          <div class="modal-body">
            <p>Some text in the modal.</p>
          </div>
          <div class="modal-footer">
            <% if(user === ''){ %>
            <button type="button" class="btn btn-default" data-dismiss="modal">
              Close
            </button>
            <% } else{ %>
            <button
              type="button"
              class="btn btn-default loginBtn"
              onclick="requestFriends()"
            >
              Request friends
            </button>
            <% } %>
          </div>
        </div>
      </div>
    </div>
    <%- include('partials/footer'); -%>
  </body>
  <%- include('partials/script'); -%>
  <!-- <script src="/js/online.js"></script> -->
  <script>
    const loggedinUserTable = document.getElementById("loggedinUser");
    const friendsListTable = document.getElementById("friendsList");

    function getCookie(cname) {
      let id = "";
      let name = cname + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(";");
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == " ") {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          for (var j = 9; j < c.substring(name.length, c.length).length; j++) {
            if (c.substring(name.length, c.length)[j] === '"') {
              break;
            } else {
              id += c.substring(name.length, c.length)[j];
            }
          }
          return id;
        }
      }
      return "";
    }

    try {
      if ($("#signIn").html() === "Sign in") {
      } else {
        socket.emit("addOnlineUser", getCookie("current-user"));
      }
    } catch (error) {
      console.error(error);
    }

    socket.on("getOnlineUsers", (onlineUsers) => {
      loggedinUserTable.innerHTML = "<tbody></tbody>";
      const keys = Object.keys(onlineUsers);
      var tableIndex = 0;
      keys.forEach((key) => {
        if (
          onlineUsers[key] != "" &&
          onlineUsers[key] != getCookie("current-user")
        ) {
          var row = loggedinUserTable
            .getElementsByTagName("tbody")[0]
            .insertRow(tableIndex)
            .insertCell(0);
          var a = document.createElement("a");
          a.innerHTML = `${onlineUsers[key]}`;
          a.setAttribute("data-toggle", "modal");
          a.setAttribute("data-target", "#showOtherUserProfileModal");
          a.setAttribute(
            "onclick",
            `putDetailsInOnlineUserModal('${onlineUsers[key]}')`
          );
          row.appendChild(a);
          tableIndex++;
        }
      });
    });

    socket.on("getFriendsList", (friendsList) => {
      friendsListTable.innerHTML = "<tbody></tbody>";
      if (friendsList === null) return 0;
      else {
        displayGetFriendsListTable(0, friendsList);
      }
    });

    socket.on("updateFriendsRequest", (PendingFriendsRequest) => {
      pendingFriendsRequestTable.innerHTML = "<tbody></tbody>";
      displayUpdateFriendsRequest(0, PendingFriendsRequest);
      toastr.success("Successfully added to your friends!");
    });

    socket.on("declineFriendsRequest", (val) => {
      if (val === 0) {
        toastr.warning("You are already friends with him/her..");
      } else if (val === 1) {
        toastr.error("You have already sent the friends request to him/her...");
      }
    });

    const putDetailsInOnlineUserModal = function (name) {
      $(".modal-title").html(name);
    };

    const requestFriends = function () {
      socket.emit(
        "friendsRequest",
        $(".modal-title").html(),
        getCookie("current-user")
      );
    };

    const displayGetFriendsListTable = function (i, friendsList) {
      if (i < friendsList.length) {
        var row = friendsListTable
          .getElementsByTagName("tbody")[0]
          .insertRow(i)
          .insertCell(0);
        var a = document.createElement("a");
        a.innerHTML = friendsList[i];
        a.href = `/chat#${friendsList[i]}`;
        row.appendChild(a);
        displayGetFriendsListTable(i + 1, friendsList);
      }
    };

    const displayUpdateFriendsRequest = function (i, PendingFriendsRequest) {
      if (i < PendingFriendsRequest.length) {
        var row = pendingFriendsRequestTable
          .getElementsByTagName("tbody")[0]
          .insertRow(i)
          .insertCell(0);
        row.innerHTML =
          PendingFriendsRequest[i] +
          `<button style='width: 50px; margin-left: 30px; border-radius: 30px;' id='${PendingFriendsRequest[i]}' onclick='acceptFriendsRequest(this.id)'>O</button><button style='width: 50px; margin-left: 30px; border-radius: 30px;' id='${PendingFriendsRequest[i]}' onclick='declineFriendsRequest(this.id)'>X</button>`;
        displayUpdateFriendsRequest(i + 1, PendingFriendsRequest);
      }
    };
  </script>
</html>
